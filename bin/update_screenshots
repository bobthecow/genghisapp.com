#!/usr/bin/env bash


# Options:
#   -W WIDTH, --width=WIDTH
#                         initial (and minimum) width of browser (default: 800)
#   -H HEIGHT, --height=HEIGHT
#                         initial (and minimum) height of browser (default: 600)
#   --clipwidth=WIDTH     width of clipped thumbnail (default: 200)
#   --clipheight=HEIGHT   height of clipped thumbnail (default: 150)
#   -s SCALE, --scale=SCALE
#                         scale factor for thumbnails (default: 0.25)
#   -o NAME, --filename=NAME
#                         save images as NAME-full.png,NAME-thumb.png etc
#   -C, --clipped         only create clipped thumbnail screenshot
#   -d, --datestamp       include date in filename
#   -D DIR, --dir=DIR     directory to place images into
#   --delay=DELAY         delay between page load finishing and screenshot
#   --noimages            don't load images
#   --transparent         render output on a transparent background (be sure to
#                         have a transparent background defined in the html)
#   --nojs                disable JavaScript support
#   --js=JS               JavaScript to execute when the window finishes loading

# screenshots:
#   - url: 'http://genghis/'
#     actions:
#       - '$("section#servers table tbody tr:first-child .databases.has-details").popover("show")'
#       - '$("a.keyboard-shortcuts").click()'
#   - url: 'http://genghis/servers/localhost'
#   - url: 'http://genghis/servers/localhost/databases/et_ut'
#     actions:
#       - '$("header nav .dropdown.database").addClass("open")'
#       - '$("section#databases table tbody tr:first-child button.destroy").click()'
#       - '$("section#databases table tbody tr:first-child button.destroy").click(); $("div.appriseOuter .aButtons button:last-child").click()'
#   - url: 'http://genghis/servers/localhost/databases/et_ut/collections/at_voluptatem_sunt'
#     actions:
#       - '$("section#documents article:first-child").find("button.edit, button.destroy").css("visibility", "visible")'
#       - '$("section#documents article:first-child button.edit").click()'
#       - '$("section#documents article:first-child button.destroy").click()'
#       - '$("button.add-document").eq(0).click()'

DIR=./content/screenshots
CMD="webkit2png --clipped --width=800 --height=600 --scale=1 --clipwidth=800 --clipheight=600 --dir=$DIR"

rm $DIR/*

$CMD -o 1  http://genghis/
$CMD -o 2  --delay=1 --js='$("section#servers table tbody tr:first-child .databases.has-details").popover("show")' http://genghis/
$CMD -o 3  --delay=1 --js='$("a.keyboard-shortcuts").click()' http://genghis/
$CMD -o 4  http://genghis/servers/localhost
$CMD -o 5  http://genghis/servers/localhost/databases/et_ut
$CMD -o 6  --delay=1 --js='$("header nav .dropdown.database").addClass("open")' http://genghis/servers/localhost/databases/et_ut
$CMD -o 7  --delay=1 --js='$("section#databases table tbody tr:first-child button.destroy").click()' http://genghis/servers/localhost/databases/et_ut
$CMD -o 8  --delay=1 --js='$("section#databases table tbody tr:first-child button.destroy").click(); $("div.appriseOuter .aButtons button:last-child").click()' http://genghis/servers/localhost/databases/et_ut
$CMD -o 9  http://genghis/servers/localhost/databases/et_ut/collections/at_voluptatem_sunt
$CMD -o 10 --delay=1 --js='$("section#documents article:first-child").find("button.edit, button.destroy").css("visibility", "visible")' http://genghis/servers/localhost/databases/et_ut/collections/at_voluptatem_sunt
$CMD -o 11 --delay=1 --js='$("section#documents article:first-child button.edit").click()' http://genghis/servers/localhost/databases/et_ut/collections/at_voluptatem_sunt
$CMD -o 12 --delay=1 --js='$("section#documents article:first-child button.destroy").click()' http://genghis/servers/localhost/databases/et_ut/collections/at_voluptatem_sunt
$CMD -o 13 --delay=1 --js='$("button.add-document").eq(0).click()' http://genghis

for file in $DIR/*; do
    mv "$file" "${file/-clipped/}"
done

convert -resize 400x300 +dither -posterize 256 -delay 100 -loop 0 $DIR/*.png $DIR/screenshots.gif
